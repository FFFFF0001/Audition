# JavaScript中的event loop

所有任务分为同步任务和异步任务。

同步任务指的是，在主线程上排队执行任务，只有前一个任务执行完毕，才执行后一个任务；

异步任务不会进入主进程，而是进入任务队列，只有“任务队列”通知主进程，某个异步任务可以执行了，该任务才会进入主进程。

异步机制的运行机制如下：

1. 所有同步任务在主线程中执行，形成一个执行栈
2. 存在一个任务队列，只要异步任务都有了结果，就在任务队列之中放置一个事件
3. 执行栈执行完时，就会读取任务队列的事件。那些对应的异步任务，于是结束等待状态进入执行栈，开始执行。

主线程从任务队列中读取事件，这个过程是循环不断的，所以整个的这种运行机制又称为Event Loop（事件循环）。

如下图（转自Philip Roberts的演讲[《Help, I'm stuck in an event-loop》](https://vimeo.com/96425312)）
![iamge](http://image.beekka.com/blog/2014/bg2014100802.png)

主线程运行的时候，产生堆（heap）和栈（stack），栈中的代码调用各种外部API，它们在任务队列中加入各种事件（click，load，done）。只要栈中的代码执行完毕，主线程就会去读取“任务队列”，依次执行那些事件所对应的回调函数。

## 定时器

除了放置异步任务的事件，“任务队列”还可以放置定时事件，即指定某些代码在多少时间之后执行。这叫做“定时器”功能。

如以下代码：

```js
console.log(1);
setTimeout(() => console.log(2))
console.log(3);
```

该代码执行的流程是，先输出1，再输出3，最后输出2。setTimeout会在当前代码执行完（执行栈清空）以后，立即执行（0秒间隔）指定的回调函数。

需要注意的是，setTimeout()只是将事件插入了“任务队列”，必须等到当前代码（执行栈）执行完，主线程才会去执行指定的回调函数。要是当前代码耗时很长，有可能要等很久，所以没有办法保证，回调函数一定会在setTimeout()指定的时间后执行。



